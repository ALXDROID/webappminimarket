<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Carrito ‚Ä¢ MiniMarket</title>

<link href="bootstrap.min.css" rel="stylesheet">

<style>
  body {
    background: #f2f2f2;
    font-family: 'Arial Rounded MT', sans-serif;
  }

  .top-banner {
    background: linear-gradient(135deg, #00b894, #019874);
    padding: 30px 20px;
    color: white;
    border-bottom-left-radius: 25px;
    border-bottom-right-radius: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    position: relative;
  }

  .banner-title {
    font-size: 26px;
    font-weight: bold;
  }

  .btn-dark-mode {
    position: absolute;
    top: 15px;
    right: 15px;
  }

  .cart-item {
    background: white;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
  }

  .cart-img {
    width: 90px;
    height: 90px;
    border-radius: 10px;
    object-fit: cover;
  }

  .qty-btn {
    background: #00b894;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 8px;
    font-size: 20px;
  }

  .delete-btn {
    background: #e74c3c;
    border: none;
    border-radius: 8px;
    width: 35px;
    height: 35px;
    color: white;
  }

  .total-box {
    background: white;
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
  }

  body.dark { background:#1e1e1e; color:#eee; }
  .dark .cart-item,
  .dark .total-box { background:#2b2b2b; }
  .dark .top-banner { background:linear-gradient(135deg,#222,#111); }
</style>
</head>

<body>

<!-- BANNER EDITANDO -->
<div id="editBanner" style="
  display:none;
  background:#00b894;
  color:white;
  padding:12px;
  text-align:center;
  font-weight:bold;">
  EDITANDO PEDIDO #<span id="banID"></span> ‚Äî Puedes modificar productos
</div>

<!-- BOT√ìN AGREGAR PRODUCTOS EN MODO EDICI√ìN -->
<div id="btnAgregarEdit" style="display:none;" class="text-center mt-3 mb-3">
  <button onclick="agregarProductos()" 
          class="btn btn-primary btn-lg fw-bold">
    ‚ûï Agregar m√°s productos
  </button>
</div>

<!-- HEADER -->
<div class="top-banner mb-4">
  <button onclick="toggleDark()" class="btn btn-light btn-sm btn-dark-mode">üåô</button>
  <div class="banner-title">üõç Tu Carrito</div>
  <div>Revisa tu pedido antes de continuar</div>
</div>

<!-- BOT√ìN EDITAR USUARIO -->
<button onclick="editarUsuario()" class="btn btn-warning btn-sm mt-2">
  ‚úèÔ∏è Editar mis datos
</button>

<!-- LISTA DEL CARRITO -->
<div class="container mb-4">
  <div id="listaCarrito"></div>
</div>

<!-- TOTAL Y PAGO -->
<div class="container mb-5">
  <div class="total-box">
    <h4>Total a pagar:</h4>
    <h2 id="total" class="text-success fw-bold">$0</h2>

    <!-- M√âTODO DE PAGO -->
    <div class="mb-3">
      <label class="form-label fw-bold">M√©todo de pago</label>
      <select id="metodoPago" class="form-select form-select-lg">
        <option value="efectivo">üíµ Efectivo</option>
        <option value="paypal">üí≥ PayPal</option>
      </select>
    </div>

    <!-- DELIVERY -->
    <div id="deliveryData" style="display:none;">
      <label class="form-label fw-bold">Direcci√≥n</label>
      <input id="dirEntrega" class="form-control mb-2">

      <label class="form-label fw-bold">Receptor</label>
      <input id="nomEntrega" class="form-control mb-2">

      <label class="form-label fw-bold">Tel√©fono</label>
      <input id="telEntrega" class="form-control mb-2" placeholder="+56 9 ...">
    </div>

    <!-- HORA -->
    <div class="mb-3">
      <label class="form-label fw-bold">Hora estimada</label>
      <input type="time" id="horaEntrega" class="form-control form-control-lg"
             min="09:30" max="22:00" required>
      <small class="text-muted">Horario permitido: 09:30 a 22:00</small>
    </div>

    <button id="btnFinal" onclick="finalizarAccion()" 
            class="btn btn-success w-100 py-3 fs-5 mt-3">
      Confirmar Pedido üî•
    </button>

  </div>
</div>

<!-- APP CORE (productos, carrito base, noti, etc.) -->
<script src="app.js"></script>

<script>
/* ============================================================
   MODO EDICI√ìN
============================================================ */
const urlParams  = new URLSearchParams(window.location.search);
const editMode   = urlParams.get("edit") === "1";
let editPedidoID = localStorage.getItem("editarPedido");

// Mostrar banner si estamos editando
if (editMode && editPedidoID) {
  document.getElementById("editBanner").style.display = "block";
  document.getElementById("banID").textContent = editPedidoID;
  document.getElementById("btnAgregarEdit").style.display = "block";
}

/* ============================================================
   CARGAR PEDIDO PARA EDITAR
============================================================ */
async function cargarPedidoParaEditar(idPedido) {
  try {
    const res  = await fetch("http://localhost/MiniMarket/api/getPedidoCompleto.php?id=" + idPedido);
    const data = await res.json();

    if (!data.success) {
      alert("No se pudo cargar el pedido.");
      return;
    }
    if (!data.editable) {
      alert("Este pedido ya no se puede editar.");
      return;
    }

    let carrito = [];
    data.items.forEach(i => {
      carrito.push({ id: Number(i.id), cantidad: Number(i.cantidad) });
    });

    guardarCarrito(carrito);
    mostrarCarritoPro();

  } catch (e) {
    console.error(e);
    alert("Error al cargar pedido.");
  }
}

// Bot√≥n agregar m√°s productos
function agregarProductos() {
  localStorage.setItem("editando", "1");
  localStorage.setItem("editarPedido", editPedidoID);
  location.href = "index.html?edit=1";
}

/* ============================================================
   MOSTRAR CARRITO COMPLETO
============================================================ */
function mostrarCarritoPro() {
  const div = document.getElementById("listaCarrito");
  div.innerHTML = "";

  let carrito = obtenerCarrito();
  let total   = 0;

  carrito.forEach(item => {
    const p = productos.find(x => x.id === item.id);
    if (!p) return;

    const subtotal = p.precio * item.cantidad;
    total += subtotal;

    div.innerHTML += `
      <div class="cart-item d-flex gap-3 align-items-center">
        <img src="${p.img}" class="cart-img">

        <div class="flex-grow-1">
          <h6 class="fw-bold mb-1">${p.nombre}</h6>
          <p class="m-0 text-success fw-bold">$${subtotal}</p>

          <div class="d-flex gap-2 mt-2">
            <button class="qty-btn" onclick="restar(${p.id})">‚àí</button>
            <span class="fw-bold fs-5">${item.cantidad}</span>
            <button class="qty-btn" onclick="sumar(${p.id})">+</button>
          </div>
        </div>

        <button class="delete-btn" onclick="eliminar(${p.id})">‚úï</button>
      </div>
    `;
  });

  document.getElementById("total").textContent = "$" + total;
}

/* ============================================================
   SUMAR / RESTAR / ELIMINAR
============================================================ */
function sumar(id) {
  let c = obtenerCarrito();
  let it = c.find(x => x.id == id);
  if (!it) return;
  it.cantidad++;
  guardarCarrito(c);
  mostrarCarritoPro();
}

function restar(id) {
  let c = obtenerCarrito();
  let it = c.find(x => x.id == id);
  if (!it) return;

  if (it.cantidad > 1) it.cantidad--;
  else c = c.filter(x => x.id != id);

  guardarCarrito(c);
  mostrarCarritoPro();
}

function eliminar(id) {
  let c = obtenerCarrito().filter(x => x.id != id);
  guardarCarrito(c);
  mostrarCarritoPro();
}

/* ============================================================
   FINALIZAR ACCI√ìN
============================================================ */
function finalizarAccion() {
  const editando = localStorage.getItem("editando") === "1";
  if (editando && editPedidoID) {
    guardarEdicion();
  } else {
    enviarPedido();
  }
}

/* ============================================================
   ENVIAR NUEVO PEDIDO
============================================================ */
async function enviarPedido() {

  const usuario = JSON.parse(localStorage.getItem("usuario") || "null");
  if (!usuario) {
    alert("Debes iniciar sesi√≥n.");
    location.href = "login.html";
    return;
  }

  const tipo    = localStorage.getItem("tipoPedido") || "retiro";
  const carrito = obtenerCarrito();

  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o.");
    return;
  }

  const metodo = document.getElementById("metodoPago").value;
  const hora   = document.getElementById("horaEntrega").value.trim();
  if (!hora) {
    alert("Debes elegir hora.");
    return;
  }

  let entrega = null;
  if (tipo === "delivery") {
    entrega = {
      direccion: document.getElementById("dirEntrega").value.trim(),
      nombre:    document.getElementById("nomEntrega").value.trim(),
      telefono:  document.getElementById("telEntrega").value.trim()
    };
    if (!entrega.direccion || !entrega.nombre || !entrega.telefono) {
      alert("Debe completar los datos de entrega.");
      return;
    }
  }

  const body = {
    id_usuario:  usuario.id,
    tipo_pedido: tipo,
    metodo_pago: metodo,
    entrega,
    hora,
    items: carrito
  };

  try {
    const res  = await fetch("http://localhost/MiniMarket/api/createPedido.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json();

    if (!data.success) {
      alert("Error: " + data.error);
      return;
    }

    localStorage.removeItem("carrito");
    localStorage.removeItem("editando");
    localStorage.removeItem("editarPedido");

    alert("Pedido N¬∫ " + data.id_pedido + " enviado ‚úî");
    location.href = "index.html";

  } catch (e) {
    console.error(e);
    alert("Error de conexi√≥n al enviar pedido.");
  }
}

/* ============================================================
   GUARDAR EDICI√ìN
============================================================ */
async function guardarEdicion() {
  const carrito = obtenerCarrito();

  if (carrito.length === 0) {
    alert("El carrito est√° vac√≠o.");
    return;
  }

  const body = {
    id_pedido: Number(editPedidoID),
    items: carrito
  };

  try {
    const res  = await fetch("http://localhost/MiniMarket/api/updatePedido.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json();

    if (!data.success) {
      alert("Error: " + data.error);
      return;
    }

    alert("Pedido actualizado ‚úî");
    localStorage.removeItem("editarPedido");
    localStorage.removeItem("editando");
    location.href = "mispedidos.html";

  } catch (e) {
    console.error(e);
    alert("Error al actualizar pedido.");
  }
}

/* ============================================================
   MOSTRAR / OCULTAR DATOS DELIVERY
============================================================ */
function syncDeliveryPanel() {
  const tipo = localStorage.getItem("tipoPedido") || "retiro";
  const box  = document.getElementById("deliveryData");
  box.style.display = (tipo === "delivery") ? "block" : "none";
}

/* ============================================================
   EDITAR USUARIO (simple)
============================================================ */
/*async function editarUsuario() {
  const u = JSON.parse(localStorage.getItem("usuario") || "{}");

  const nuevoNombre = prompt("Nuevo nombre:", u.nombre || "");
  if (!nuevoNombre) return;

  const nuevoTel = prompt("Nuevo tel√©fono (internacional):", u.telefono ? "+"+u.telefono : "+569");
  if (!nuevoTel) return;

  const nuevoAvatar = prompt("URL avatar:", u.avatar || "");

  let telClean = nuevoTel.replace(/[\s\-()]/g, "");
  if (!/^\+?\d{8,15}$/.test(telClean)) {
    alert("N√∫mero inv√°lido.");
    return;
  }
  telClean = telClean.replace("+", "");

  const actualizado = {
    id: u.id,
    nombre: nuevoNombre,
    telefono: telClean,
    avatar: nuevoAvatar
  };

  localStorage.setItem("usuario", JSON.stringify(actualizado));

  try {
    const res = await fetch("http://localhost/MiniMarket/api/updateUsuario.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(actualizado)
    });
    const data = await res.json();
    if (!data.success) {
      alert("Error servidor: " + data.error);
      return;
    }
    alert("Datos actualizados ‚úî");
  } catch (e) {
    alert("Error de conexi√≥n");
    console.error(e);
  }
}*/
const avatares = [
   "http://localhost/MiniMarket/img/avatar18_ibhr6v.png",
  "http://localhost/MiniMarket/img/avatar19_jp5vr2.png",
  "http://localhost/MiniMarket/img/avatar20_weeikg.png",
  "http://localhost/MiniMarket/img/avatar17_ubirol.png",
  "http://localhost/MiniMarket/img/avatar14_drp6wb.png",
  "http://localhost/MiniMarket/img/avatar15_gyexku.png",
  "http://localhost/MiniMarket/img/avatar16_ks63db.png",
  "http://localhost/MiniMarket/img/avatar10_abnwb9.png",
  "http://localhost/MiniMarket/img/avatar13_hrbesa.png",
  "http://localhost/MiniMarket/img/avatar11_cnclyo.png",
  "http://localhost/MiniMarket/img/avatar6_pppi62.png",
  "http://localhost/MiniMarket/img/avatar12_vselyz.png",
  "http://localhost/MiniMarket/img/avatar9_hb4lhx.png",
  "http://localhost/MiniMarket/img/avatar8_xgh3a9.png",
  "http://localhost/MiniMarket/img/avatar5_rtg7nd.png",
  "http://localhost/MiniMarket/img/avatar4_vvxcsf.png",
  "http://localhost/MiniMarket/img/avatar3_w1p55d.png",
  "http://localhost/MiniMarket/img/avatar2_g6ynyq.png",
  "http://localhost/MiniMarket/img/avatar7_m6lyhw.png",
  "http://localhost/MiniMarket/img/avatar1_ciei4n.png"
];

let avatarSeleccionado = "";

/* ===========================================
   EDITAR USUARIO
=========================================== */
function editarUsuario() {
  const u = JSON.parse(localStorage.getItem("usuario"));

  avatarSeleccionado = u.avatar || "img/avatar1_ciei4n.png";

  editAvatarPreview.src = avatarSeleccionado;
  editNombre.value = u.nombre;
  editTelefono.value = u.telefono;

  new bootstrap.Modal(document.getElementById("modalEditarUsuario")).show();
}

/* ===========================================
   MOSTRAR AVATARES PREDEFINIDOS
=========================================== */
function mostrarSelectorAvatares() {
  const cont = document.getElementById("listaAvatares");
  cont.innerHTML = "";

  avatares.forEach(url => {
    const img = document.createElement("img");
    img.src = url;
    img.style = `
      width:70px;height:70px;border-radius:50%;
      cursor:pointer;border:4px solid transparent
    `;
    img.onclick = () => {
      avatarSeleccionado = url;
      editAvatarPreview.src = url;
    };
    cont.appendChild(img);
  });

  new bootstrap.Modal(document.getElementById("modalAvatares")).show();
}

/* ===========================================
   GUARDAR USUARIO (con foto o avatar)
=========================================== */
async function guardarCambiosUsuario() {
  const u = JSON.parse(localStorage.getItem("usuario"));

  const nombre = editNombre.value.trim();
  let telefono = editTelefono.value.trim().replace(/\D/g, "");

  if (!nombre || !telefono) return alert("Completa todos los campos");

  let avatarFinal = avatarSeleccionado;

  // 1) Si el usuario seleccion√≥ una foto real
  const archivo = document.getElementById("inputFoto").files[0];

  if (archivo) {
    const f = new FormData();
    f.append("foto", archivo);
    f.append("id_usuario", u.id);

    let r = await fetch("http://localhost/MiniMarket/api/uploadAvatar.php", {
      method: "POST",
      body: f
    });

    const resFoto = await r.json();

    if (resFoto.success) {
      avatarFinal = resFoto.url; // URL del archivo subido
    } else {
      alert("Error subiendo foto: " + resFoto.error);
      return;
    }
  }

  // 2) Actualizar usuario
  const dataUser = {
    id: u.id,
    nombre,
    telefono,
    avatar: avatarFinal
  };

  const r2 = await fetch("http://localhost/MiniMarket/api/updateUsuario.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dataUser)
  });

  const resUpd = await r2.json();

  if (!resUpd.success) {
    alert("Error servidor: " + resUpd.error);
    return;
  }

  // 3) Guardar local
  localStorage.setItem("usuario", JSON.stringify(dataUser));

  alert("Datos actualizados ‚úî");
  location.reload();
}
/* ============================================================
   DARK MODE
============================================================ */
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("darkmode", document.body.classList.contains("dark"));
}
if (localStorage.getItem("darkmode") === "true") {
  document.body.classList.add("dark");
}

/* ============================================================
   INIT
============================================================ */
document.addEventListener("DOMContentLoaded", async () => {
syncDeliveryPanel();
  await cargarProductos();

  const editMode = new URLSearchParams(location.search).get("edit") === "1";
  const editPedidoID = localStorage.getItem("editarPedido");

  if (editMode && editPedidoID) {

      const skip = localStorage.getItem("skipReload") === "1";

      if (!skip) {
        // Primera vez ‚Üí cargamos datos del pedido original
        await cargarPedidoParaEditar(editPedidoID);
      } else {
        // Las siguientes veces ‚Üí mostrar carrito modificado
        mostrarCarritoPro();
      }

      // limpiar skip para que no afecte futuros accesos
      localStorage.removeItem("skipReload");
  } 
  else {
    // No es modo edici√≥n ‚Üí carrito normal
    mostrarCarritoPro();
  }

});

</script>
<!-- ================================
     MODAL: EDITAR USUARIO
================================ -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Editar mis datos</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="text-center mb-3">
          <img id="editAvatarPreview" class="rounded-circle"
               style="width:110px;height:110px;object-fit:cover;border:4px solid #00b894;">
        </div>

        <!-- Bot√≥n seleccionar avatar predefinido -->
        <div class="text-center mb-3">
          <button class="btn btn-outline-success btn-sm" onclick="mostrarSelectorAvatares()">
            Elegir avatar
          </button>
        </div>

        <!-- Bot√≥n subir foto real -->
        <div class="text-center mb-3">
          <input type="file" id="inputFoto" accept="image/*" class="form-control">
        </div>

        <label class="form-label fw-bold">Nombre</label>
        <input id="editNombre" class="form-control mb-3">

        <label class="form-label fw-bold">Tel√©fono</label>
        <input id="editTelefono" class="form-control mb-3" placeholder="+56912345678">

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="guardarCambiosUsuario()">Guardar</button>
      </div>

    </div>
  </div>
</div>

<!-- ================================
     MODAL: AVATARES
================================ -->
<div class="modal fade" id="modalAvatares" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Seleccionar avatar</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="listaAvatares" class="d-flex flex-wrap justify-content-center" style="gap:10px;"></div>
      </div>

    </div>
  </div>
</div>
<script src="bootstrap.bundle.min.js" type="text/javascript"></script>
</body>
</html>
