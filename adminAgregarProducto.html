<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Administrar Productos</title>

<link href="bootstrap.min.css" rel="stylesheet">

</head>
<body class="p-3">

<h3 class="mb-4">üõí Administrar Productos</h3>

<div class="card p-3 mb-4">
  <h5 id="formTitulo">‚ûï Agregar Producto</h5>

  <input type="hidden" id="idProducto">

  <div class="mb-3">
    <label class="form-label">Nombre</label>
    <input id="nombre" class="form-control">
  </div>

  <div class="mb-3">
    <label class="form-label">Precio</label>
    <input id="precio" type="number" class="form-control">
  </div>

  <div class="mb-3">
    <label class="form-label">Categor√≠a</label>
    <select id="categoria" class="form-control"></select>
  </div>

  <div class="mb-3">
    <label class="form-label">Imagen</label>
    <input id="imagen" type="file" accept="image/*" class="form-control">
  </div>

  <button onclick="guardar()" class="btn btn-success w-100 py-2">Guardar</button>
</div>
<hr class="my-4">

<h3>üìÇ Categor√≠as</h3>

<div class="card p-3 mb-3">
    <h5>‚ûï Agregar / Editar Categor√≠a</h5>

    <input type="hidden" id="catId">

    <div class="mb-3">
        <label class="form-label">Nombre categor√≠a</label>
        <input id="catNombre" class="form-control">
    </div>

    <button onclick="guardarCategoria()" class="btn btn-primary w-100">
        Guardar Categor√≠a
    </button>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="tablaCategorias"></tbody>
</table>

<h4>üìã Productos registrados</h4>

<table class="table table-striped">
  <thead>
    <tr>
      <th>IMG</th>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Categor√≠a</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tablaProductos"></tbody>
</table>

<script>
const API = "http://localhost/MiniMarket/api/";
async function cargarCategorias() {
    const r = await fetch(API + "listarCategorias.php");
    const cats = await r.json();

    const sel = document.getElementById("categoria");
    sel.innerHTML = "";

   cats.forEach(c => {
    sel.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
  });

}
document.addEventListener("DOMContentLoaded", () => {
    cargarCategorias();       // para el select
    cargarProductos();        // lista productos
    cargarCategoriasPanel();  // lista categor√≠as
});

// =====================
// LISTAR PRODUCTOS
// =====================
async function cargarProductos() {
  const r = await fetch(API + "listarProductos.php");
  const d = await r.json();

  let html = "";

  d.forEach(p => {
    html += `
      <tr>
        <td><img src="http://localhost/MiniMarket/uploads/${p.imagen}" width="50"></td>
        <td>${p.nombre}</td>
        <td>$${p.precio}</td>
        <td>${p.categoria}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editar(${p.id})">‚úèÔ∏è Editar</button>
          <button class="btn btn-danger btn-sm" onclick="eliminar(${p.id})">üóëÔ∏è Eliminar</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("tablaProductos").innerHTML = html;
}
async function cargarCategoriasPanel() {
    const r = await fetch(API + "listarCategorias.php");
    const cats = await r.json();

    let html = "";
    cats.forEach(c => {
        html += `
        <tr>
            <td>${c.nombre}</td>
            <td>${c.activo == 1 ? "üü¢ Activa" : "üî¥ Inactiva"}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editarCategoria(${c.id}, '${c.nombre}')">‚úèÔ∏è Editar</button>
                <button class="btn btn-danger btn-sm" onclick="desactivarCategoria(${c.id})">‚ùå Desactivar</button>
            </td>
        </tr>
        `;
    });

    document.getElementById("tablaCategorias").innerHTML = html;
}

// Para cargar el formulario al editar
function editarCategoria(id, nombre) {
    document.getElementById("catId").value = id;
    document.getElementById("catNombre").value = nombre;
}

// Guardar o editar
async function guardarCategoria() {
    const id = document.getElementById("catId").value;
    const nombre = document.getElementById("catNombre").value.trim();

    if (!nombre) {
        alert("Ingresa un nombre de categor√≠a");
        return;
    }

    const data = { id, nombre };

    const r = await fetch(API + "guardarCategoria.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    const d = await r.json();
    alert(d.mensaje);

    document.getElementById("catId").value = "";
    document.getElementById("catNombre").value = "";

    cargarCategorias(); // recarga SELECT del producto
    cargarCategoriasPanel(); // recarga TABLA
}

// Desactivar
async function desactivarCategoria(id) {
    if (!confirm("¬øDesactivar categor√≠a?")) return;

    const r = await fetch(API + "eliminarCategoria.php?id=" + id);
    const d = await r.json();

    alert(d.mensaje);
    cargarCategoriasPanel();
    cargarCategorias();
}

// =====================
// CARGAR INFO PARA EDITAR
// =====================
async function editar(id) {
  const r = await fetch(API + "obtenerProducto.php?id=" + id);
  const p = await r.json();

  document.getElementById("idProducto").value = p.id;
  document.getElementById("nombre").value = p.nombre;
  document.getElementById("precio").value = p.precio;
  document.getElementById("categoria").value = p.categoria;

  document.getElementById("formTitulo").innerText = "‚úèÔ∏è Editando producto";
  window.scrollTo(0, 0);
}

// =====================
// GUARDAR (AGREGAR O EDITAR)
// =====================
async function guardar() {

  const id = document.getElementById("idProducto").value;
  const nombre = document.getElementById("nombre").value.trim();
  const precio = document.getElementById("precio").value;
  const categoria = document.getElementById("categoria").value;
  const imgFile = document.getElementById("imagen").files[0];

  if (!nombre || !precio) {
    alert("Completa todos los campos obligatorios");
    return;
  }

  let nombreImagen = null;

  if (imgFile) {
    let form = new FormData();
    form.append("imagen", imgFile);

    const r1 = await fetch(API + "subirImagen.php", {
      method: "POST",
      body: form,
      credentials: "include"
    });

    const d1 = await r1.json();
    if (!d1.success) { alert("Error subiendo imagen"); return; }
    nombreImagen = d1.archivo;
  }

  // OBJETO PARA ENVIAR
  const body = { id, nombre, precio, categoria, imagen: nombreImagen };

  const r2 = await fetch(API + "guardarEditarProducto.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    credentials: "include"
  });

  const d2 = await r2.json();

  alert(d2.mensaje);
  cargarProductos();
  cargarProductos();
}
function resetFormulario() {
    document.getElementById("idProducto").value = "";
    document.getElementById("nombre").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("categoria").value = "Bebidas"; 
    document.getElementById("imagen").value = "";
    document.getElementById("formTitulo").innerText = "‚ûï Agregar Producto";
}

// =====================
// ELIMINAR PRODUCTO
// =====================
async function eliminar(id) {
  if (!confirm("¬øSeguro de eliminar este producto?")) return;

  const r = await fetch(API + "eliminarProducto.php?id=" + id);
  const d = await r.json();

  alert(d.mensaje);
  cargarProductos();
}
</script>

</body>
</html>
