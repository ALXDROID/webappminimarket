<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Carrito ‚Ä¢ MiniMarket</title>

<link href="bootstrap.min.css" rel="stylesheet">

<style>
  body {
    background: #f2f2f2;
    font-family: 'Arial Rounded MT', sans-serif;
  }

  /* HEADER */
  .top-banner {
    background: linear-gradient(135deg, #00b894, #019874);
    padding: 30px 20px;
    color: white;
    border-bottom-left-radius: 25px;
    border-bottom-right-radius: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    position: relative;
  }

  .banner-title {
    font-size: 26px;
    font-weight: bold;
  }

  .btn-dark-mode {
    position: absolute;
    top: 15px;
    right: 15px;
  }

  /* ITEM CARRITO */
  .cart-item {
    background: white;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
  }

  .cart-img {
    width: 90px;
    height: 90px;
    border-radius: 10px;
    object-fit: cover;
  }

  .qty-btn {
    background: #00b894;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 8px;
    font-size: 20px;
  }

  .delete-btn {
    background: #e74c3c;
    border: none;
    border-radius: 8px;
    width: 35px;
    height: 35px;
    color: white;
  }

  /* TOTAL */
  .total-box {
    background: white;
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.12);
  }

  /* DARK MODE */
  body.dark {
    background: #1e1e1e;
    color: #eee;
  }

  .dark .cart-item,
  .dark .total-box {
    background: #2b2b2b;
    box-shadow: 0 0 15px rgba(255,255,255,0.05);
  }

  .dark .top-banner {
    background: linear-gradient(135deg, #222, #111);
  }

</style>

</head>
<body>
<div id="editBanner" style="
  display:none;
  background:#00b894;
  color:white;
  padding:12px;
  text-align:center;
  font-weight:bold;
">
  EDITANDO PEDIDO #<span id="banID"></span> ‚Äî Puedes modificar productos
</div>

<!-- HEADER -->
<div class="top-banner mb-4">
  <button onclick="toggleDark()" 
          class="btn btn-light btn-sm btn-dark-mode">üåô</button>

  <div class="banner-title">üõç Tu Carrito</div>
  <div>Revisa tu pedido antes de continuar</div>
</div>
<button onclick="editarUsuario()" 
        class="btn btn-warning btn-sm mt-2">
  ‚úèÔ∏è Editar mis datos
</button>

<div class="container mb-4">
  <div id="listaCarrito"></div>
</div>

<!-- TOTAL -->
<div class="container mb-5">
  <div class="total-box">
    <h4>Total a pagar:</h4>
    <h2 id="total" class="text-success fw-bold">$0</h2>
<!-- M√âTODO DE PAGO -->
<div class="container mb-3">
  <label class="form-label fw-bold">M√©todo de pago</label>
  <select id="metodoPago" class="form-select form-select-lg">
    <option value="efectivo">üíµ Efectivo</option>
    <option value="paypal">üí≥ PayPal</option>
  </select>
</div>

<!-- DATOS DELIVERY -->
<div id="deliveryData" class="container mb-3" style="display:none;">
  <label class="form-label fw-bold">Direcci√≥n de entrega</label>
  <input id="dirEntrega" class="form-control form-control-lg mb-2" placeholder="Calle, n√∫mero, depto">

  <label class="form-label fw-bold">Nombre del receptor</label>
  <input id="nomEntrega" class="form-control form-control-lg mb-2" placeholder="Nombre completo">

  <label class="form-label fw-bold">Tel√©fono</label>
  <input id="telEntrega" class="form-control form-control-lg mb-2" placeholder="+56 9 ...">
</div>
<script>
    // Detectar modo edici√≥n
const urlParams = new URLSearchParams(window.location.search);
const editMode = urlParams.get("edit");
let editPedidoID = localStorage.getItem("editarPedido");

// Si viene en modo edici√≥n ‚Üí cargar desde BD
if (editMode && editPedidoID) {
  document.getElementById("editBanner").style.display = "block";
  document.getElementById("banID").textContent = editPedidoID;

  cargarPedidoParaEditar(editPedidoID);
}


const tipoPedido = localStorage.getItem("tipoPedido") || "retiro";

function actualizarDeliveryUI() {
  const box = document.getElementById("deliveryData");
  if (tipoPedido === "delivery") {
    box.style.display = "block";
  } else {
    box.style.display = "none";
  }
}
async function cargarPedidoParaEditar(idPedido) {

  try {
    const res = await fetch("http://localhost/MiniMarket/api/getPedidoCompleto.php?id=" + idPedido);
    const data = await res.json();

    if (!data.success) {
      alert("No se pudo cargar el pedido.");
      return;
    }

    if (!data.editable) {
      alert("Este pedido ya no se puede editar (pagado o queda <30 min)");
      return;
    }

    // Cargar productos al carrito local
    let carrito = [];

    data.items.forEach(i => {
      carrito.push({
        id: i.id,
        cantidad: parseInt(i.cantidad)
      });
    });

    guardarCarrito(carrito);
    mostrarCarritoPro();

  } catch (e) {
    console.error(e);
  }
}
async function editarUsuario() {
  const u = JSON.parse(localStorage.getItem("usuario") || "{}");

  const nuevoNombre = prompt("Nuevo nombre:", u.nombre);
  if (!nuevoNombre) return;

  const nuevoTel = prompt("Nuevo tel√©fono (internacional):", "+" + u.telefono);
  if (!nuevoTel) return;

  // limpieza
  let telClean = nuevoTel.replace(/[\s\-()]/g, "");

  // validar formato E.164
  if (!/^\+?\d{8,15}$/.test(telClean)) {
    alert("N√∫mero inv√°lido. Ej: +56912345678, +14155552671");
    return;
  }

  // quitar +
  telClean = telClean.replace("+", "");

  // guardar en localStorage
  localStorage.setItem("usuario", JSON.stringify({
    id: u.id,
    nombre: nuevoNombre,
    telefono: telClean
  }));

  // üî• enviar a MySQL
  try {
    const res = await fetch("http://localhost/MiniMarket/api/updateUsuario.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: u.id,
        nombre: nuevoNombre,
        telefono: telClean
      })
    });

    const data = await res.json();

    if (!data.success) {
      alert("Error al guardar en servidor: " + data.error);
      return;
    }

    alert("Datos actualizados correctamente ‚úî");
    location.reload();

  } catch (e) {
    alert("Error de conexi√≥n severo üö®");
    console.error(e);
  }
}
actualizarDeliveryUI();
</script>

    <!-- HORA DE ENTREGA / RETIRO -->
<div class="container mb-3">
  <label class="form-label fw-bold">Hora estimada</label>
  <input 
    type="time" 
    id="horaEntrega" 
    class="form-control form-control-lg"
    min="09:30"
    max="22:00"
    required
  >
  <small class="text-muted">Horario permitido: 09:30 a 22:00 (solo hoy)</small>
</div>


   <button id="btnFinal" onclick="finalizarAccion()" class="btn btn-success w-100 py-3 fs-5 mt-3">
  Confirmar Pedido üî•
</button>

  </div>
</div>

<script src="app.js"></script>
<script>

// -------------------------
// INICIALIZACI√ìN CORRECTA
// -------------------------
document.addEventListener("DOMContentLoaded", async () => {

  // 1) Cargar productos desde InfinityFree
  await cargarProductos();

  // 2) Mostrar carrito reci√©n cuando productos est√©n listos
  mostrarCarritoPro();
});


// -------------------------
// MOSTRAR CARRITO PRO
// -------------------------
function mostrarCarritoPro() {
  const div = document.getElementById("listaCarrito");
  div.innerHTML = "";

  let carrito = obtenerCarrito();
  let total = 0;

  carrito.forEach(item => {

    let p = productos.find(x => x.id === item.id);

    // ‚Üê‚Üê‚Üê NUEVO: prevenir el error
    if (!p) {
      console.warn("Producto inexistente en backend, removido del carrito:", item.id);
      carrito = carrito.filter(x => x.id !== item.id);
      guardarCarrito(carrito);
      return;
    }

    let subtotal = p.precio * item.cantidad;
    total += subtotal;

    div.innerHTML += `
      <div class="cart-item d-flex gap-3 align-items-center">
        <img src="${p.img}" class="cart-img">

        <div class="flex-grow-1">
          <h6 class="fw-bold mb-1">${p.nombre}</h6>
          <p class="m-0 text-success fw-bold">$${subtotal}</p>

          <div class="d-flex gap-2 mt-2">
            <button class="qty-btn" onclick="restar(${p.id})">‚àí</button>
            <span class="fw-bold fs-5">${item.cantidad}</span>
            <button class="qty-btn" onclick="sumar(${p.id})">+</button>
          </div>
        </div>

        <button class="delete-btn" onclick="eliminar(${p.id})">‚úï</button>
      </div>
    `;
  });

  document.getElementById("total").textContent = "$" + total;
}



// -------------------------
// SUMAR
// -------------------------
function sumar(id) {
  let carrito = obtenerCarrito();
  let item = carrito.find(x => x.id == id);

  item.cantidad++;
  guardarCarrito(carrito);
  mostrarCarritoPro();
}


// -------------------------
// RESTAR
// -------------------------
function restar(id) {
  let carrito = obtenerCarrito();
  let item = carrito.find(x => x.id == id);

  if (item.cantidad > 1) {
    item.cantidad--;
  } else {
    carrito = carrito.filter(x => x.id != id);
  }

  guardarCarrito(carrito);
  mostrarCarritoPro();
}


// -------------------------
// ELIMINAR
// -------------------------
function eliminar(id) {
  let carrito = obtenerCarrito().filter(x => x.id != id);
  guardarCarrito(carrito);
  mostrarCarritoPro();
}


// -------------------------
// ENVIAR PEDIDO
// -------------------------
async function enviarPedido() {

  const usuario = JSON.parse(localStorage.getItem("usuario") || "null");
  if (!usuario) {
    alert("Debes iniciar sesi√≥n para enviar un pedido.");
    location.href = "login.html";
    return;
  }

  const tipo = localStorage.getItem("tipoPedido") || "retiro";
  const carrito = obtenerCarrito();

  if (carrito.length === 0) {
    alert("Tu carrito est√° vac√≠o.");
    return;
  }

  /*const body = {
    id_usuario: usuario.id,
    tipo_pedido: tipo,
    items: carrito
  };*/
const metodo = document.getElementById("metodoPago").value;

// Datos delivery
let entrega = null;

if (tipo === "delivery") {
  entrega = {
    direccion: document.getElementById("dirEntrega").value.trim(),
    nombre:    document.getElementById("nomEntrega").value.trim(),
    telefono:  document.getElementById("telEntrega").value.trim(),
  };

  // Validar
  if (!entrega.direccion || !entrega.nombre || !entrega.telefono) {
    alert("Debe completar los datos de entrega.");
    return;
  }
}

const hora = document.getElementById("horaEntrega").value.trim();

// VALIDAR HORA ANTES DE ENVIAR
if (!hora) {
  alert("Debes seleccionar una hora para el pedido.");
  return;
}

// Validaci√≥n JS (adem√°s de la validaci√≥n PHP)
const [hh, mm] = hora.split(":").map(Number);
const minutos = hh * 60 + mm;

if (minutos < 570 || minutos > 1320) { // 570=9:30, 1320=22:00
  alert("La hora debe ser entre 09:30 y 22:00.");
  return;
}

const body = {
  id_usuario: usuario.id,
  tipo_pedido: tipo,
  metodo_pago: metodo,
  entrega,
  hora: hora,     // üëà NUEVO üî•üî•üî•
  items: carrito
};


  try {
    const res = await fetch("http://localhost/MiniMarket/api/createPedido.php/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!data.success) {
      alert("Error al enviar pedido: " + (data.error || "Desconocido"));
      return;
    }

    localStorage.removeItem("carrito");

    let hist = JSON.parse(localStorage.getItem("historial") || "[]");
    hist.push({
      id_pedido: data.id_pedido,
      total: data.total,
      fecha: new Date().toLocaleString()
    });
    localStorage.setItem("historial", JSON.stringify(hist));

    noti("Pedido N¬∫ " + data.id_pedido + " enviado üéâ");

    setTimeout(() => {
      location.href = "index.html";
    }, 1400);

  } catch (e) {
    alert("Error de conexi√≥n con el servidor.");
    console.error(e);
  }
}
function finalizarAccion() {
  if (editMode) {
    guardarEdicion();
  } else {
    enviarPedido();
  }
}
async function guardarEdicion() {

  let carrito = obtenerCarrito();

  if (carrito.length === 0) {
    alert("El carrito est√° vac√≠o.");
    return;
  }

/*  const body = {
    id_pedido: parseInt(editPedidoID),
    items: carrito
  };*/

  const res = await fetch("http://localhost/MiniMarket/api/updatePedido.php", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(body)
  });

  const data = await res.json();

  if (!data.success) {
    alert("Error: " + data.error);
    return;
  }

  alert("Pedido actualizado correctamente üíö");
  localStorage.removeItem("editarPedido");
  location.href = "mispedidos.html";
}


// -------------------------
// NOTIFICACI√ìN
// -------------------------
function noti(msg){
  const box = document.createElement("div");
  box.style.position = "fixed";
  box.style.bottom = "20px";
  box.style.left = "50%";
  box.style.transform = "translateX(-50%)";
  box.style.background = "#00b894";
  box.style.color = "white";
  box.style.padding = "15px 25px";
  box.style.borderRadius = "12px";
  box.style.boxShadow = "0 6px 18px rgba(0,0,0,0.25)";
  box.style.zIndex = "9999";
  box.style.fontSize = "18px";
  box.innerText = msg;

  document.body.appendChild(box);
  navigator.vibrate?.(80);

  setTimeout(() => box.remove(), 2000);
}


// -------------------------
// DARK MODE
// -------------------------
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("darkmode", document.body.classList.contains("dark"));
}

if (localStorage.getItem("darkmode") === "true") {
  document.body.classList.add("dark");
}


</script>

</body>
</html>
