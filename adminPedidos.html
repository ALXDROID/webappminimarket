<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Pedidos</title>
<link rel="stylesheet"
 href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

<style>
body {
  background: #f8f9fa;
  font-family: 'Arial Rounded MT', sans-serif;
}

/* LAYOUT */
.container-pedidos {
  display: flex;
  gap: 20px;
}

/* LISTA IZQUIERDA */
.lista {
  width: 35%;
  height: 90vh;
  overflow-y: auto;
  border-right: 3px solid #ddd;
  padding-right: 10px;
}

.item-pedido {
  background: white;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: 0.2s;
  border-left: 6px solid #0d6efd;
}

.item-pedido:hover {
  background: #eef6ff;
}

.item-activo {
  background: #d9ecff !important;
  border-left-color: #0069d9 !important;
}

/* PANEL DERECHA */
.detalle {
  width: 65%;
  background: white;
  border-radius: 15px;
  padding: 20px;
  min-height: 90vh;
  box-shadow: 0 0 10px rgba(0,0,0,0.08);
}

.badge-pendiente { background:#ffc107; }
.badge-pagado { background:#28a745; }
.badge-anulado { background:#dc3545; }

.items { 
  font-size: 14px; 
  margin-left: 10px; 
}
</style>
</head>

<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-3">ðŸ›’ Panel Administrador â€“ Vista Dandy Elegante</h2>

  <div class="container-pedidos">
    
    <!-- LISTA IZQUIERDA -->
    <div class="lista" id="listaPedidos"></div>

    <!-- PANEL DE DETALLE -->
    <div class="detalle" id="detallePedido">
      <h4 class="text-muted">Selecciona un pedido â†’</h4>
    </div>

  </div>
</div>

<script>
let pedidos = [];
let pedidoActual = null;

// =====================================================
// CARGAR PEDIDOS REAL DE TU API getPedidosAdmin.php
// =====================================================
function cargar() {
  fetch("https://marketapp.kesug.com/api/getPedidosAdmin.php")
  .then(r => r.json())
  .then(data => {
    if (!data.success) return;

    pedidos = data.pedidos;
    renderLista();
  })
  .catch(e => console.error("Error:", e));
}

// =====================================================
// LISTA IZQUIERDA
// =====================================================
function renderLista() {
  const div = document.getElementById("listaPedidos");
  div.innerHTML = "";

  pedidos.forEach(p => {

    const badge =
      p.estado === "pendiente" ? "badge-pendiente" :
      p.estado === "pagado" ? "badge-pagado" : "badge-anulado";

    div.innerHTML += `
      <div class="item-pedido" onclick="verPedido(${p.id})" id="item${p.id}">
        <b>#${p.id}</b> â€” ${p.usuario}<br>
        <small>${p.tipo} | $${p.total} | ${p.hora_entrega ?? "Sin hora"}</small><br>
        <span class="badge ${badge}">${p.estado}</span>
      </div>
    `;
  });
}

// =====================================================
// PANEL DERECHA
// =====================================================
function verPedido(id) {

  pedidoActual = pedidos.find(p => p.id == id);

  document.querySelectorAll(".item-pedido").forEach(
    el => el.classList.remove("item-activo")
  );
  document.getElementById("item" + id).classList.add("item-activo");

  let p = pedidoActual;

  let itemsHtml = "";
  p.items.forEach(i => {
    itemsHtml += `<div class="items">â€¢ ${i.nombre} (x${i.cantidad}) â€” $${i.subtotal}</div>`;
  });

  document.getElementById("detallePedido").innerHTML = `
    <h3>Pedido #${p.id}</h3>
    
    <p><b>Cliente:</b> ${p.usuario}</p>
    <p><b>TelÃ©fono:</b> ${p.telefono || "â€”"}</p>
    <p><b>Tipo:</b> ${p.tipo}</p>

    ${p.tipo === "delivery" ? `
      <p><b>DirecciÃ³n:</b> ${p.direccion}</p>
      <p><b>Receptor:</b> ${p.receptor}</p>
    ` : ""}

    <p><b>MÃ©todo de pago:</b> ${p.metodo}</p>
    <p><b>Hora entrega:</b> ${p.hora_entrega ?? "No especificada"}</p>
    <p><b>Total:</b> $${p.total}</p>
    
    <hr>

    <h5>Items</h5>
    ${itemsHtml}

    <hr>

    <label class="fw-bold">Estado del pedido:</label>
    <select id="estadoNuevo" class="form-select w-50 mb-3">
      <option value="pendiente" ${p.estado=="pendiente"?'selected':''}>Pendiente</option>
      <option value="pagado" ${p.estado=="pagado"?'selected':''}>Pagado</option>
      <option value="anulado" ${p.estado=="anulado"?'selected':''}>Anulado</option>
    </select>

    <button onclick="actualizar(${p.id})" class="btn btn-primary">
      Guardar cambios
    </button>
  `;
}

// =====================================================
// ACTUALIZAR ESTADO
// =====================================================
function actualizar(id) {
  let nuevo = document.getElementById("estadoNuevo").value;

  const body = new FormData();
  body.append("id", id);
  body.append("estado", nuevo);

  fetch("https://marketapp.kesug.com/api/updateEstado.php", {
    method: "POST",
    body
  })
  .then(r => r.json())
  .then(res => {
    alert("Estado actualizado âœ”");
    cargar();
  })
  .catch(e => console.error(e));
}

cargar();
setInterval(cargar, 6000);  // Refresh elegante
</script>

</body>
</html>
